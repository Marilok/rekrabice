"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.watcher = exports.createWatcherInstance = void 0;
var node_fs_1 = __importDefault(require("node:fs"));
var node_path_1 = __importDefault(require("node:path"));
var chokidar_1 = require("chokidar");
var shelljs_1 = require("shelljs");
var constants_1 = require("./constants");
var generate_email_preview_1 = require("./generate-email-preview");
var createWatcherInstance = function (watchDir) {
    var watcher = (0, chokidar_1.watch)(watchDir, {
        ignoreInitial: true,
        cwd: watchDir.split(node_path_1.default.sep).slice(0, -1).join(node_path_1.default.sep),
        ignored: /(^|[/\\])\../,
    });
    // Catches ctrl+c event
    var exit = function () {
        void watcher.close();
    };
    process.on('SIGINT', exit);
    process.on('uncaughtException', exit);
    return watcher;
};
exports.createWatcherInstance = createWatcherInstance;
var watcher = function (watcherInstance, watchDir) {
    watcherInstance.on('all', function (event, filename) {
        var file = filename.split(node_path_1.default.sep);
        if (file[1] === undefined) {
            return;
        }
        if (event === constants_1.EVENT_FILE_DELETED) {
            if (file[1] === 'static' && file[2]) {
                node_fs_1.default.rmSync(node_path_1.default.join(constants_1.REACT_EMAIL_ROOT, 'public', 'static', file[2]));
                return;
            }
            node_fs_1.default.rmSync(node_path_1.default.join(constants_1.REACT_EMAIL_ROOT, filename));
            return;
        }
        if (file[1] === 'static' && file[2]) {
            var srcPath = node_path_1.default.join(watchDir, 'static', file[2]);
            var result = (0, shelljs_1.cp)('-r', srcPath, node_path_1.default.join(constants_1.REACT_EMAIL_ROOT, 'public', 'static'));
            if (result.code > 0) {
                throw new Error("Something went wrong while copying the file to ".concat(constants_1.PACKAGE_EMAILS_PATH, ", ").concat(result.cat()));
            }
            return;
        }
        void (0, generate_email_preview_1.generateEmailsPreview)(watchDir, 'templates');
    });
};
exports.watcher = watcher;
